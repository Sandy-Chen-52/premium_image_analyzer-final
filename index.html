<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ECF 免費圖像解析與生成器 - 深色版</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
            min-height: 100vh;
            overflow-x: auto;
            color: #e2e8f0;
        }

        .container {
            width: 100%;
            max-width: 1920px;
            margin: 0 auto;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.5);
        }

        .header {
            background: linear-gradient(135deg, #1e293b 0%, #334155 50%, #475569 100%);
            color: #f1f5f9;
            padding: 25px 40px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
            border-bottom: 1px solid rgba(148, 163, 184, 0.1);
        }

        .header h1 {
            font-size: 2.2rem;
            margin-bottom: 8px;
            text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.5);
            color: #f1f5f9;
            font-weight: 700;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.85;
            color: #cbd5e1;
        }

        .main-content {
            display: flex;
            flex: 1;
            min-height: calc(100vh - 120px);
        }

        /* 左側面板 */
        .left-panel {
            width: 400px;
            background: linear-gradient(180deg, #1e293b 0%, #334155 100%);
            padding: 25px;
            border-right: 1px solid rgba(148, 163, 184, 0.15);
            overflow-y: auto;
            height: calc(100vh - 120px);
            position: sticky;
            top: 120px;
            backdrop-filter: blur(10px);
        }

        /* 中間主要區域 */
        .center-panel {
            flex: 1;
            padding: 25px;
            overflow-y: auto;
            background: linear-gradient(180deg, #0f172a 0%, #1e293b 100%);
        }

        /* 右側面板 */
        .right-panel {
            width: 450px;
            background: linear-gradient(180deg, #1e293b 0%, #334155 100%);
            padding: 25px;
            border-left: 1px solid rgba(148, 163, 184, 0.15);
            overflow-y: auto;
            height: calc(100vh - 120px);
            position: sticky;
            top: 120px;
            backdrop-filter: blur(10px);
        }

        .panel-section {
            margin-bottom: 30px;
            padding: 25px;
            background: rgba(30, 41, 59, 0.6);
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(148, 163, 184, 0.1);
            backdrop-filter: blur(20px);
            transition: all 0.3s ease;
        }

        .panel-section:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
        }

        .panel-section h3 {
            color: #60a5fa;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.2rem;
            font-weight: 600;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        /* 圖像上傳區域 */
        .image-upload-area {
            border: 2px dashed #60a5fa;
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.4), rgba(51, 65, 85, 0.4));
            transition: all 0.4s ease;
            cursor: pointer;
            margin: 25px 0;
            position: relative;
            overflow: hidden;
            min-height: 320px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(10px);
        }

        .image-upload-area::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent, rgba(96, 165, 250, 0.1), transparent);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .image-upload-area:hover {
            border-color: #34d399;
            background: linear-gradient(135deg, rgba(52, 211, 153, 0.1), rgba(96, 165, 250, 0.1));
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(96, 165, 250, 0.2);
        }

        .image-upload-area:hover::before {
            opacity: 1;
        }

        .image-upload-area.dragover {
            border-color: #34d399;
            background: linear-gradient(135deg, rgba(52, 211, 153, 0.2), rgba(96, 165, 250, 0.2));
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }

        .uploaded-image-preview {
            max-width: 100%;
            max-height: 280px;
            border-radius: 15px;
            margin: 15px auto;
            display: block;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.4);
            transition: transform 0.3s ease;
            border: 1px solid rgba(148, 163, 184, 0.2);
        }

        .uploaded-image-preview:hover {
            transform: scale(1.05);
        }

        .control-btn {
            padding: 10px 18px;
            border: 2px solid #60a5fa;
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.8), rgba(51, 65, 85, 0.8));
            border-radius: 25px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            color: #60a5fa;
            transition: all 0.3s ease;
            margin: 5px;
            box-shadow: 0 4px 15px rgba(96, 165, 250, 0.2);
            backdrop-filter: blur(10px);
        }

        .control-btn:hover {
            background: linear-gradient(135deg, #60a5fa, #34d399);
            color: #0f172a;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(96, 165, 250, 0.4);
            border-color: transparent;
        }

        .control-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* 結果顯示區域 */
        .results-area {
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.6), rgba(51, 65, 85, 0.6));
            border-radius: 20px;
            padding: 25px;
            margin: 25px 0;
            border: 1px solid rgba(52, 211, 153, 0.3);
            display: none;
            backdrop-filter: blur(20px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .result-item {
            margin-bottom: 20px;
            padding: 20px;
            background: rgba(15, 23, 42, 0.6);
            border-radius: 15px;
            border: 1px solid rgba(148, 163, 184, 0.1);
            backdrop-filter: blur(10px);
        }

        .result-label {
            font-weight: 700;
            color: #34d399;
            margin-bottom: 12px;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 10px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .result-content {
            color: #cbd5e1;
            font-size: 0.95rem;
            line-height: 1.6;
            background: rgba(15, 23, 42, 0.8);
            padding: 15px;
            border-radius: 12px;
            border: 1px solid rgba(148, 163, 184, 0.1);
            backdrop-filter: blur(10px);
        }

        /* 輸入框樣式 */
        .input-field {
            width: 100%;
            padding: 15px;
            border: 2px solid rgba(148, 163, 184, 0.2);
            border-radius: 15px;
            font-size: 0.95rem;
            background: rgba(15, 23, 42, 0.8);
            color: #e2e8f0;
            transition: all 0.3s ease;
            margin-bottom: 12px;
            backdrop-filter: blur(10px);
        }

        .input-field:focus {
            border-color: #60a5fa;
            outline: none;
            box-shadow: 0 0 0 4px rgba(96, 165, 250, 0.2);
            background: rgba(30, 41, 59, 0.9);
        }

        .input-field::placeholder {
            color: #64748b;
        }

        .textarea-field {
            width: 100%;
            padding: 15px;
            border: 2px solid rgba(148, 163, 184, 0.2);
            border-radius: 15px;
            font-size: 0.95rem;
            background: rgba(15, 23, 42, 0.8);
            color: #e2e8f0;
            resize: vertical;
            min-height: 100px;
            transition: all 0.3s ease;
            margin-bottom: 12px;
            backdrop-filter: blur(10px);
        }

        .textarea-field:focus {
            border-color: #60a5fa;
            outline: none;
            box-shadow: 0 0 0 4px rgba(96, 165, 250, 0.2);
            background: rgba(30, 41, 59, 0.9);
        }

        .textarea-field::placeholder {
            color: #64748b;
        }

        /* 設定網格 */
        .settings-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 25px;
        }

        .setting-item {
            display: flex;
            flex-direction: column;
        }

        .setting-item label {
            margin-bottom: 8px;
            font-weight: 600;
            color: #cbd5e1;
            font-size: 0.95rem;
        }

        .setting-item input, .setting-item select {
            padding: 12px;
            border: 2px solid rgba(148, 163, 184, 0.2);
            border-radius: 12px;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            background: rgba(15, 23, 42, 0.8);
            color: #e2e8f0;
            backdrop-filter: blur(10px);
        }

        .setting-item input:focus, .setting-item select:focus {
            border-color: #60a5fa;
            outline: none;
            box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.2);
        }

        .setting-item select option {
            background: #1e293b;
            color: #e2e8f0;
        }

        /* 平台選擇器 */
        .platform-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
        }

        .platform-option {
            display: flex;
            align-items: center;
            padding: 15px;
            border: 2px solid rgba(148, 163, 184, 0.2);
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(15, 23, 42, 0.6);
            font-size: 0.9rem;
            backdrop-filter: blur(10px);
        }

        .platform-option.selected {
            border-color: #60a5fa;
            background: rgba(96, 165, 250, 0.1);
            box-shadow: 0 0 20px rgba(96, 165, 250, 0.2);
        }

        .platform-option:hover {
            border-color: #34d399;
            background: rgba(52, 211, 153, 0.1);
            transform: translateY(-1px);
        }

        .platform-option input[type="radio"] {
            margin-right: 12px;
            accent-color: #60a5fa;
        }

        /* 生成按鈕 */
        .generate-btn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #60a5fa, #34d399);
            color: #0f172a;
            border: none;
            border-radius: 30px;
            font-size: 1.2rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.4s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin: 25px 0;
            box-shadow: 0 8px 30px rgba(96, 165, 250, 0.3);
            position: relative;
            overflow: hidden;
        }

        .generate-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .generate-btn:hover::before {
            left: 100%;
        }

        .generate-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 40px rgba(96, 165, 250, 0.4);
        }

        .generate-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* 載入動畫 */
        .loading {
            display: none;
            text-align: center;
            margin: 25px 0;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(96, 165, 250, 0.2);
            border-top: 4px solid #60a5fa;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* 圖像結果展示 */
        .image-results {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 25px;
            margin: 25px 0;
        }

        .image-result-item {
            background: rgba(15, 23, 42, 0.8);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            text-align: center;
            border: 1px solid rgba(148, 163, 184, 0.1);
            backdrop-filter: blur(20px);
            transition: transform 0.3s ease;
        }

        .image-result-item:hover {
            transform: translateY(-5px);
        }

        .preview-image {
            max-width: 100%;
            max-height: 280px;
            border-radius: 15px;
            cursor: pointer;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
            margin-bottom: 15px;
            border: 1px solid rgba(148, 163, 184, 0.2);
            transition: transform 0.3s ease;
        }

        .preview-image:hover {
            transform: scale(1.05);
        }

        .download-btn {
            margin: 5px;
            padding: 10px 18px;
            background: linear-gradient(135deg, #34d399, #10b981);
            color: #0f172a;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 0.85rem;
            box-shadow: 0 4px 15px rgba(52, 211, 153, 0.3);
        }

        .download-btn:hover {
            background: linear-gradient(135deg, #10b981, #059669);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(52, 211, 153, 0.4);
        }

        /* 摺疊面板 */
        .collapsible-header {
            cursor: pointer;
            user-select: none;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: color 0.3s ease;
        }

        .collapsible-header:hover {
            color: #34d399;
        }

        .collapsible-content {
            max-height: 1000px;
            overflow: hidden;
            transition: max-height 0.4s ease;
        }

        .collapsible-content.collapsed {
            max-height: 0;
            padding: 0;
            margin: 0;
        }

        /* 模板按鈕 */
        .template-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }

        .template-btn {
            padding: 8px 15px;
            border: 2px solid rgba(148, 163, 184, 0.3);
            background: rgba(15, 23, 42, 0.8);
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 500;
            color: #cbd5e1;
            transition: all 0.3s ease;
            text-align: center;
            backdrop-filter: blur(10px);
        }

        .template-btn:hover {
            border-color: #60a5fa;
            background: rgba(96, 165, 250, 0.1);
            color: #60a5fa;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(96, 165, 250, 0.2);
        }

        /* 歷史記錄 */
        .history-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 20px;
        }

        .history-item {
            background: rgba(15, 23, 42, 0.8);
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            transition: transform 0.3s ease;
            border: 1px solid rgba(148, 163, 184, 0.1);
            backdrop-filter: blur(20px);
        }

        .history-item:hover {
            transform: translateY(-5px);
        }

        .history-image {
            width: 100%;
            height: 140px;
            object-fit: cover;
        }

        .history-info {
            padding: 12px;
        }

        .history-prompt {
            font-size: 0.8rem;
            color: #cbd5e1;
            margin-bottom: 8px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .history-date {
            font-size: 0.75rem;
            color: #64748b;
            margin-bottom: 10px;
        }

        .history-actions {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .history-btn {
            padding: 5px 10px;
            border: 1px solid rgba(148, 163, 184, 0.3);
            background: rgba(30, 41, 59, 0.8);
            border-radius: 12px;
            cursor: pointer;
            font-size: 0.75rem;
            transition: all 0.3s ease;
            color: #cbd5e1;
            backdrop-filter: blur(10px);
        }

        .history-btn:hover {
            background: rgba(96, 165, 250, 0.2);
            border-color: #60a5fa;
            color: #60a5fa;
        }

        /* API 狀態 */
        .api-status {
            position: fixed;
            top: 25px;
            right: 25px;
            padding: 12px 20px;
            border-radius: 30px;
            font-size: 0.9rem;
            font-weight: 600;
            z-index: 1000;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.4);
            transition: all 0.3s ease;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(148, 163, 184, 0.2);
        }

        .api-status.connected {
            background: linear-gradient(135deg, #10b981, #059669);
            color: #f0fdf4;
        }

        .api-status.connecting {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: #fffbeb;
        }

        .api-status.error {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: #fef2f2;
        }

        /* 訊息提示 */
        .info-box {
            background: rgba(59, 130, 246, 0.1);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 1px solid rgba(59, 130, 246, 0.3);
            font-size: 0.9rem;
            color: #93c5fd;
            backdrop-filter: blur(10px);
        }

        .warning-box {
            background: rgba(245, 158, 11, 0.1);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 1px solid rgba(245, 158, 11, 0.3);
            font-size: 0.9rem;
            color: #fbbf24;
            backdrop-filter: blur(10px);
        }

        /* 響應式設計 */
        @media (max-width: 1400px) {
            .right-panel {
                width: 380px;
            }
            .left-panel {
                width: 380px;
            }
        }

        @media (max-width: 1200px) {
            .main-content {
                flex-direction: column;
            }
            
            .left-panel, .right-panel {
                width: 100%;
                height: auto;
                position: static;
            }
            
            .center-panel {
                order: 1;
            }
            
            .left-panel {
                order: 2;
            }
            
            .right-panel {
                order: 3;
            }
        }

        @media (max-width: 768px) {
            .header {
                padding: 20px 25px;
            }
            
            .header h1 {
                font-size: 1.8rem;
            }
            
            .left-panel, .center-panel, .right-panel {
                padding: 20px;
            }
            
            .settings-grid {
                grid-template-columns: 1fr;
            }
            
            .template-grid {
                grid-template-columns: repeat(auto-fit, minmax(110px, 1fr));
            }
        }

        .error, .success {
            padding: 18px;
            border-radius: 12px;
            margin: 20px 0;
            display: none;
            font-weight: 600;
            font-size: 0.95rem;
            backdrop-filter: blur(20px);
        }

        .error {
            background: rgba(239, 68, 68, 0.1);
            color: #fca5a5;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .success {
            background: rgba(34, 197, 94, 0.1);
            color: #86efac;
            border: 1px solid rgba(34, 197, 94, 0.3);
        }

        /* 滾動條樣式 */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(30, 41, 59, 0.3);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(96, 165, 250, 0.5);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(96, 165, 250, 0.7);
        }

        /* 玻璃效果 */
        .glass-effect {
            background: rgba(30, 41, 59, 0.3);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(148, 163, 184, 0.1);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🤖 ECF Premium 免費圖像解析與生成器</h1>
            <p>智能拍照圖像識別 + AI 故事生成 + 圖像創作</p>
        </div>
        
        <div class="main-content">
            <!-- 左側面板：設定與工具 -->
            <div class="left-panel">
                <!-- API 設定 -->
                <div class="panel-section">
                    <div class="collapsible-header" onclick="toggleSection('apiConfig')">
                        <h3>🔑 Gemini API 設定</h3>
                        <span id="apiConfigToggle">▼</span>
                    </div>
                    <div id="apiConfigContent" class="collapsible-content">
                        <div class="info-box">
                            🔐 您的 API Key 僅保存在瀏覽器本地，不會上傳到任何服務器。
                        </div>
                        <input 
                            type="password" 
                            id="apiKey" 
                            class="input-field" 
                            placeholder="請輸入您的 Gemini API Key"
                            style="font-family: monospace; font-size: 0.85rem;"
                        >
                        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                            <button class="control-btn" onclick="toggleApiKeyVisibility()">👁️ 顯示</button>
                            <button class="control-btn" onclick="testApiKey()">🔍 測試</button>
                            <button class="control-btn" onclick="clearApiKey()">🗑️ 清空</button>
                            <button class="control-btn" onclick="showApiKeyHelp()">❓ 幫助</button>
                        </div>
                        <div id="apiKeyStatus" style="margin-top: 12px; padding: 10px; border-radius: 8px; display: none; font-size: 0.85rem;"></div>
                    </div>
                </div>

                <!-- 平台選擇 -->
                <div class="panel-section">
                    <h3>🚀 AI 生成平台</h3>
                    <div class="warning-box">
                        <strong>平台說明：</strong><br>
                        • 標準：FLUX 模型，速度快<br>
                        • 增強：啟用增強功能<br>
                        • SDXL：高品質渲染
                    </div>
                    <div class="platform-grid">
                        <label class="platform-option selected" for="pollinations">
                            <input type="radio" name="platform" value="pollinations" id="pollinations" checked>
                            <div>
                                <div style="font-weight: 600;">Pollinations 標準</div>
                                <div style="font-size: 0.8rem; color: #64748b;">快速穩定</div>
                            </div>
                        </label>
                        
                        <label class="platform-option" for="pollinations_enhanced">
                            <input type="radio" name="platform" value="pollinations_enhanced" id="pollinations_enhanced">
                            <div>
                                <div style="font-weight: 600;">Pollinations 增強</div>
                                <div style="font-size: 0.8rem; color: #64748b;">啟用增強</div>
                            </div>
                        </label>
                        
                        <label class="platform-option" for="pollinations_sdxl">
                            <input type="radio" name="platform" value="pollinations_sdxl" id="pollinations_sdxl">
                            <div>
                                <div style="font-weight: 600;">Pollinations SDXL</div>
                                <div style="font-size: 0.8rem; color: #64748b;">高品質</div>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- 生成設定 -->
                <div class="panel-section">
                    <h3>⚙️ 生成設定</h3>
                    <div class="settings-grid">
                        <div class="setting-item">
                            <label for="width">寬度</label>
                            <input type="number" id="width" value="1024" min="256" max="2048" step="64">
                        </div>
                        <div class="setting-item">
                            <label for="height">高度</label>
                            <input type="number" id="height" value="1024" min="256" max="2048" step="64">
                        </div>
                        <div class="setting-item">
                            <label for="seed">種子值</label>
                            <input type="number" id="seed" value="100" min="1" max="999999">
                        </div>
                        <div class="setting-item">
                            <label for="batchCount">批量生成</label>
                            <select id="batchCount">
                                <option value="1">單張圖像</option>
                                <option value="2">生成 2 張</option>
                                <option value="4">生成 4 張</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="setting-item">
                        <label for="style">🎨 藝術風格</label>
                        <select id="style">
                            <option value="">無特定風格</option>
                            <optgroup label="🎬 動畫風格">
                                <option value="Pixar animation style, 3D rendered">🎬 Pixar 動畫風格</option>
                                <option value="anime style, manga art">🌸 日本動漫風</option>
                                <option value="Studio Ghibli style, soft colors">🌿 吉卜力工作室</option>
                                <option value="cartoon style, colorful">🎪 卡通風格</option>
                            </optgroup>
                            <optgroup label="🎨 繪畫風格">
                                <option value="watercolor painting, soft brushstrokes">🖌️ 水彩畫</option>
                                <option value="oil painting, thick brushstrokes">🎨 油畫風格</option>
                                <option value="digital art, vibrant colors">💻 數位藝術</option>
                                <option value="photorealistic, high resolution">📷 寫實風格</option>
                                <option value="black and white sketch, pencil drawing, monochrome">✏️ 黑白素描</option>
                                <option value="colored pencil drawing, soft colors, textured">🖍️ 色鉛筆</option>
                            </optgroup>
                            <optgroup label="🌍 特效風格">
                                <option value="cyberpunk style, neon lights">🌃 賽博朋克</option>
                                <option value="fantasy art, magical atmosphere">🧙 奇幻風格</option>
                                <option value="sci-fi art, futuristic">🚀 科幻風格</option>
                                <option value="vintage style, retro aesthetic">📼 復古風格</option>
                            </optgroup>
                        </select>
                    </div>
                </div>

                <!-- 風格模板 -->
                <div class="panel-section">
                    <div class="collapsible-header" onclick="toggleSection('templates')">
                        <h3>📋 風格模板</h3>
                        <span id="templatesToggle">▼</span>
                    </div>
                    <div id="templatesContent" class="collapsible-content">
                        <div style="margin-bottom: 18px;">
                            <h4 style="margin-bottom: 10px; font-size: 0.95rem; color: #cbd5e1;">🏃 運動風格</h4>
                            <div class="template-grid">
                                <button class="template-btn" onclick="applyTemplate('人物攝影')">人物攝影</button>
                                <button class="template-btn" onclick="applyTemplate('街拍風格')">街拍風格</button>
                                <button class="template-btn" onclick="applyTemplate('豎型構圖')">豎型構圖</button>
                            </div>
                        </div>
                        <div style="margin-bottom: 18px;">
                            <h4 style="margin-bottom: 10px; font-size: 0.95rem; color: #cbd5e1;">🎨 藝術風格</h4>
                            <div class="template-grid">
                                <button class="template-btn" onclick="applyTemplate('光芒背景')">光芒背景</button>
                                <button class="template-btn" onclick="applyTemplate('古風意境')">古風意境</button>
                                <button class="template-btn" onclick="applyTemplate('浪漫意境')">浪漫意境</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 負面提示詞 -->
                <div class="panel-section">
                    <div class="collapsible-header" onclick="toggleSection('negative')">
                        <h3>❌ 負面提示詞</h3>
                        <span id="negativeToggle">▼</span>
                    </div>
                    <div id="negativeContent" class="collapsible-content">
                        <textarea 
                            id="negativePrompt" 
                            class="textarea-field" 
                            style="min-height: 80px; border-color: rgba(239, 68, 68, 0.5);"
                            placeholder="不想要的元素：模糊、低畫質、扭曲..."
                        ></textarea>
                        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                            <button class="control-btn" style="border-color: #ef4444; color: #ef4444;" onclick="applyCommonNegatives()">📝 常用</button>
                            <button class="control-btn" style="border-color: #ef4444; color: #ef4444;" onclick="enhanceNegatives()">🔧 完善</button>
                            <button class="control-btn" style="border-color: #ef4444; color: #ef4444;" onclick="clearNegatives()">🗑️ 清空</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 中間面板：主要工作區 -->
            <div class="center-panel">
                <!-- Gemini AI 圖像分析 -->
                <div class="panel-section">
                    <h3>🧠 Gemini AI 圖像解析</h3>
                    
                    <div class="image-upload-area" onclick="handleUploadAreaClick(event)" 
                         ondrop="handleImageDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                        <input type="file" id="imageUpload" accept="image/*" style="display: none;" onchange="handleImageUpload(event)">
                        <canvas id="cameraCanvas" style="display: none;"></canvas>
                        <div id="uploadContent">
                            <div style="font-size: 3rem; margin-bottom: 15px;">📸</div>
                            <p style="font-size: 1.2rem; margin-bottom: 10px; color: #60a5fa; font-weight: 600;">上傳或拍照進行 AI 分析</p>
                            <p style="color: #94a3b8; font-size: 1rem;">點擊選擇圖片、拖拽圖片到此處或使用相機拍照</p>
                            <p style="color: #64748b; font-size: 0.85rem; margin-top: 10px;">支援 JPG、PNG、WebP 格式 (最大 10MB)</p>
                            <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                                <button class="control-btn" onclick="event.stopPropagation(); document.getElementById('imageUpload').click()">📁 選擇檔案</button>
                                <button class="control-btn" onclick="event.stopPropagation(); directCameraCapture()">📷 直接拍照</button>
                            </div>
                        </div>
                        <div id="imagePreview" style="display: none;">
                            <img id="previewImg" class="uploaded-image-preview" alt="預覽圖像">
                            <div style="margin-top: 20px;">
                                <button class="control-btn" onclick="event.stopPropagation(); removeImage()">🗑️ 移除</button>
                                <button class="control-btn" onclick="event.stopPropagation(); document.getElementById('imageUpload').click()">📁 重新選擇</button>
                                <button class="control-btn" onclick="event.stopPropagation(); directCameraCapture()">📷 重新拍照</button>
                                <button class="control-btn" onclick="event.stopPropagation(); analyzeWithGemini()" id="analyzeBtn">🧠 Gemini 解析</button>
                                <button class="control-btn" onclick="event.stopPropagation(); generatePixarStory()" id="pixarBtn" style="display: none;">🎬 Pixar 故事</button>
                                <button class="control-btn" onclick="event.stopPropagation(); applyToPrompt()" id="applyBtn" style="display: none;">✨ 應用到提示詞</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Gemini 分析結果 -->
                    <div id="geminiResults" class="results-area">
                        <div class="collapsible-header" onclick="toggleSection('geminiResultsContent')">
                            <h4 style="color: #34d399; margin-bottom: 0; display: flex; align-items: center; gap: 10px;">
                                🎯 Gemini AI 解析結果
                            </h4>
                            <span id="geminiResultsContentToggle">▼</span>
                        </div>
                        <div id="geminiResultsContentContent" class="collapsible-content">
                            <div id="geminiContent" style="margin-top: 18px;"></div>
                        </div>
                    </div>
                    
                    <!-- Pixar 故事結果 -->
                    <div id="pixarResults" class="results-area" style="border-color: rgba(239, 68, 68, 0.3);">
                        <div class="collapsible-header" onclick="toggleSection('pixarResultsContent')">
                            <h4 style="color: #f87171; margin-bottom: 0; display: flex; align-items: center; gap: 10px;">
                                🎬 Pixar 風格故事創作
                            </h4>
                            <span id="pixarResultsContentToggle">▼</span>
                        </div>
                        <div id="pixarResultsContentContent" class="collapsible-content">
                            <div id="pixarContent" style="margin-top: 18px;"></div>
                        </div>
                    </div>
                </div>

                <!-- 提示詞輸入 -->
                <div class="panel-section">
                    <h3>✨ 描述您想要的圖像</h3>
                    <textarea 
                        id="prompt" 
                        class="textarea-field" 
                        style="min-height: 120px;"
                        placeholder="例如：一隻可愛的貓咪坐在彩虹橋上，背景是夢幻的星空，Pixar 動畫風格，3D 渲染，高品質"
                    ></textarea>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px;">
                        <button class="control-btn" onclick="generateRandomPrompt()">🎲 隨機靈感</button>
                        <button class="control-btn" onclick="clearPrompt()">🗑️ 清空</button>
                        <button class="control-btn" onclick="enhancePrompt()">✨ 美化描述</button>
                    </div>
                    
                    <button id="generateBtn" class="generate-btn" onclick="generateImage()">
                        🚀 生成 AI 圖像
                    </button>
                    
                    <div id="loading" class="loading">
                        <div class="spinner"></div>
                        <p style="font-size: 1.1rem; color: #60a5fa; font-weight: 600;">AI 正在為您創作圖像，請稍候...</p>
                    </div>
                    
                    <div id="error" class="error"></div>
                    <div id="success" class="success"></div>
                </div>

                <!-- 圖像生成結果 -->
                <div id="result" style="margin-top: 25px;"></div>
            </div>

            <!-- 右側面板：歷史記錄與額外功能 -->
            <div class="right-panel">
                <!-- 歷史創作記錄 -->
                <div class="panel-section">
                    <div class="collapsible-header" onclick="toggleSection('history')">
                        <h3>📚 歷史創作</h3>
                        <span id="historyToggle">▼</span>
                    </div>
                    <div id="historyContent" class="collapsible-content">
                        <div class="warning-box">
                            💡 最多保留最近 10 筆創作記錄，超過後會自動刪除最舊的記錄。
                        </div>
                        <div id="historyGrid" class="history-grid">
                            <div style="text-align: center; color: #64748b; padding: 40px;">
                                🎨 您的創作歷史將在這裡顯示<br>
                                <small>開始生成圖像後，最近作品會自動保存</small>
                            </div>
                        </div>
                        <div style="text-align: center; margin-top: 20px;">
                            <button class="control-btn" onclick="clearHistory()">🗑️ 清空歷史</button>
                        </div>
                    </div>
                </div>

                <!-- 快速設定 -->
                <div class="panel-section">
                    <h3>⚡ 快速設定</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px;">
                        <button class="control-btn" onclick="setDimensions(1920, 1080)">🖥️ 1920×1080</button>
                        <button class="control-btn" onclick="setDimensions(1080, 1920)">📱 1080×1920</button>
                        <button class="control-btn" onclick="setDimensions(1024, 1024)">⬜ 1024×1024</button>
                        <button class="control-btn" onclick="setDimensions(512, 768)">📄 512×768</button>
                    </div>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="control-btn" onclick="randomSeed()">🎲 隨機種子</button>
                        <button class="control-btn" onclick="resetSettings()">🔄 重置設定</button>
                    </div>
                </div>

                <!-- 使用說明 -->
                <div class="panel-section">
                    <div class="collapsible-header" onclick="toggleSection('guide')">
                        <h3>📖 使用說明</h3>
                        <span id="guideToggle">▼</span>
                    </div>
                    <div id="guideContent" class="collapsible-content collapsed">
                        <div style="font-size: 0.9rem; line-height: 1.7; color: #cbd5e1;">
                            <h4 style="color: #60a5fa; margin-bottom: 10px;">🔧 基本使用：</h4>
                            <p style="margin-bottom: 12px;">1. 在左側設定 Gemini API Key（用於圖像解析）</p>
                            <p style="margin-bottom: 12px;">2. 選擇 AI 生成平台</p>
                            <p style="margin-bottom: 12px;">3. 在中間輸入描述文字</p>
                            <p style="margin-bottom: 18px;">4. 點擊生成按鈕</p>
                            
                            <h4 style="color: #60a5fa; margin-bottom: 10px;">🎨 進階功能：</h4>
                            <p style="margin-bottom: 12px;">• 上傳圖像進行 AI 解析</p>
                            <p style="margin-bottom: 12px;">• 使用風格模板快速套用</p>
                            <p style="margin-bottom: 12px;">• 設定負面提示詞排除不要的元素</p>
                            <p style="margin-bottom: 18px;">• 批量生成多張圖像</p>
                            
                            <h4 style="color: #60a5fa; margin-bottom: 10px;">💡 提示：</h4>
                            <p style="margin-bottom: 12px;">• 使用英文描述效果更好</p>
                            <p style="margin-bottom: 12px;">• 詳細的描述能獲得更好的結果</p>
                            <p>• 嘗試不同的種子值獲得變化</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- API 狀態指示器 -->
    <div id="apiStatus" class="api-status connecting">🔄 連接 Gemini AI</div>

    <script>
        // 全局變量
        let userApiKey = "";
        let referenceImageFile = null;
        let currentAnalysisResults = {};
        let geminiAnalysisData = null;
        let historyData = [];

        // Google Gemini API 配置
        function getGeminiApiUrl() {
            if (!userApiKey) {
                throw new Error('請先在設定中輸入 Gemini API Key');
            }
            return `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${userApiKey}`;
        }

        // 直接拍照功能
        async function directCameraCapture() {
            try {
                // 使用 HTML5 的 getUserMedia API 直接拍照
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        facingMode: 'user' // 可改為 'environment' 使用後置鏡頭
                    } 
                });
                
                // 創建隱藏的 video 元素來獲取畫面
                const video = document.createElement('video');
                video.style.display = 'none';
                video.srcObject = stream;
                video.autoplay = true;
                document.body.appendChild(video);
                
                showToast('📷 正在啟動相機，請稍候...', 'warning');
                
                // 等待視頻流準備就緒
                video.addEventListener('loadedmetadata', () => {
                    setTimeout(() => {
                        // 創建 canvas 來擷取畫面
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        // 設置 canvas 尺寸
                        canvas.width = video.videoWidth;
                        canvas.height = video.videoHeight;
                        
                        // 擷取當前畫面
                        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                        
                        // 停止視頻流
                        const tracks = stream.getTracks();
                        tracks.forEach(track => track.stop());
                        
                        // 移除臨時 video 元素
                        document.body.removeChild(video);
                        
                        // 將 canvas 轉換為 Blob
                        canvas.toBlob(function(blob) {
                            if (blob) {
                                // 創建 File 對象
                                const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                                const file = new File([blob], `direct_capture_${timestamp}.jpg`, { 
                                    type: 'image/jpeg' 
                                });
                                
                                // 處理拍攝的圖像
                                processSelectedImage(file, '📷 拍照完成');
                            } else {
                                showToast('❌ 拍照失敗', 'error');
                            }
                        }, 'image/jpeg', 0.8);
                        
                    }, 1000); // 給相機一點時間初始化
                });
                
            } catch (error) {
                console.error('直接拍照失敗:', error);
                if (error.name === 'NotAllowedError') {
                    showToast('❌ 相機權限被拒絕，請允許使用相機', 'error');
                } else if (error.name === 'NotFoundError') {
                    showToast('❌ 找不到相機設備', 'error');
                } else {
                    showToast('❌ 拍照失敗: ' + error.message, 'error');
                }
            }
        }

        // 基礎工具函數
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.textContent = message;
            const bgColor = type === 'error' ? 'linear-gradient(135deg, #ef4444, #dc2626)' : 
                           type === 'warning' ? 'linear-gradient(135deg, #f59e0b, #d97706)' : 
                           'linear-gradient(135deg, #10b981, #059669)';
            toast.style.cssText = `
                position: fixed; 
                top: 90px; 
                right: 25px; 
                background: ${bgColor}; 
                color: white; 
                padding: 15px 25px; 
                border-radius: 30px; 
                z-index: 1001; 
                box-shadow: 0 8px 30px rgba(0,0,0,0.4);
                font-weight: 600;
                font-size: 0.95rem;
                backdrop-filter: blur(20px);
                border: 1px solid rgba(255,255,255,0.1);
            `;
            
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 4000);
        }

        // 更新 API 狀態
        function updateApiStatus(status, message) {
            const statusEl = document.getElementById('apiStatus');
            statusEl.className = `api-status ${status}`;
            statusEl.textContent = message;
            
            if (status === 'connected') {
                setTimeout(() => {
                    statusEl.style.opacity = '0.8';
                }, 3000);
            }
        }

        // API Key 管理功能
        function toggleApiKeyVisibility() {
            const apiKeyInput = document.getElementById('apiKey');
            const toggleBtn = event.target;
            
            if (apiKeyInput.type === 'password') {
                apiKeyInput.type = 'text';
                toggleBtn.textContent = '👁️ 隱藏';
                showToast('👁️ API Key 已顯示');
            } else {
                apiKeyInput.type = 'password';
                toggleBtn.textContent = '👁️ 顯示';
                showToast('🔒 API Key 已隱藏');
            }
        }

        async function testApiKey() {
            const apiKeyInput = document.getElementById('apiKey');
            const key = apiKeyInput.value.trim();
            
            if (!key) {
                showToast('❌ 請先輸入 API Key', 'error');
                return;
            }
            
            if (!key.startsWith('AIza') || key.length < 30) {
                showToast('❌ API Key 格式不正確', 'error');
                showApiKeyStatus('error', '❌ API Key 格式錯誤：應以 "AIza" 開頭且長度足夠');
                return;
            }
            
            try {
                showApiKeyStatus('info', '🔍 測試 API Key 連接...');
                updateApiStatus('connecting', '🔄 測試連接中...');
                
                const testUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${key}`;
                const testBody = {
                    contents: [{
                        parts: [{
                            text: "Hello"
                        }]
                    }]
                };
                
                const response = await fetch(testUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(testBody)
                });
                
                if (response.ok) {
                    userApiKey = key;
                    showApiKeyStatus('success', '✅ API Key 測試成功，連接正常');
                    showToast('✅ API Key 有效且可以正常使用');
                    updateApiStatus('connected', '✅ Gemini API 已連接');
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(`API 測試失敗: ${response.status} - ${errorData.error?.message || '未知錯誤'}`);
                }
                
            } catch (error) {
                console.error('API Key 測試錯誤:', error);
                showApiKeyStatus('error', '❌ API Key 測試失敗: ' + error.message);
                showToast('❌ API Key 測試失敗: ' + error.message, 'error');
                updateApiStatus('error', '❌ API 連接失敗');
                
                if (error.message.includes('CORS') || error.message.includes('fetch')) {
                    showApiKeyStatus('error', '❌ 由於瀏覽器 CORS 限制，無法直接測試 API。但您可以儲存 API Key 並嘗試使用圖像分析功能。');
                    userApiKey = key;
                }
            }
        }

        function clearApiKey() {
            const apiKeyInput = document.getElementById('apiKey');
            
            if (confirm('確定要清空 API Key 嗎？')) {
                apiKeyInput.value = '';
                apiKeyInput.type = 'password';
                userApiKey = '';
                
                // 重置顯示按鈕文字
                const toggleBtn = document.querySelector('button[onclick="toggleApiKeyVisibility()"]');
                if (toggleBtn) {
                    toggleBtn.textContent = '👁️ 顯示';
                }
                
                showApiKeyStatus('info', '🗑️ API Key 已清空');
                showToast('🗑️ API Key 已清空');
                updateApiStatus('connecting', '🔄 請設定 API Key');
            }
        }

        function showApiKeyHelp() {
            const helpText = `📖 如何獲取 Gemini API Key：

1. 訪問 Google AI Studio: https://aistudio.google.com/app/apikey
2. 登錄您的 Google 帳戶
3. 點擊 "Create API Key" 按鈕
4. 選擇或創建一個 Google Cloud 項目
5. 複製生成的 API Key
6. 將 API Key 粘貼到上方輸入框

⚠️ 重要注意事項：
- API Key 以 "AIza" 開頭
- 請妥善保管您的 API Key，不要與他人分享
- 本工具的 API Key 僅保存在您的瀏覽器中，不會上傳到服務器

💡 使用提示：
- 輸入 API Key 後，點擊 "測試" 按鈕驗證有效性
- 使用 "顯示/隱藏" 按鈕查看輸入的內容
- 如需更換 API Key，請先點擊 "清空" 按鈕`;
            
            alert(helpText);
        }

        function showApiKeyStatus(type, message) {
            const statusDiv = document.getElementById('apiKeyStatus');
            statusDiv.style.display = 'block';
            
            if (type === 'success') {
                statusDiv.style.background = 'rgba(34, 197, 94, 0.1)';
                statusDiv.style.color = '#86efac';
                statusDiv.style.border = '1px solid rgba(34, 197, 94, 0.3)';
            } else if (type === 'error') {
                statusDiv.style.background = 'rgba(239, 68, 68, 0.1)';
                statusDiv.style.color = '#fca5a5';
                statusDiv.style.border = '1px solid rgba(239, 68, 68, 0.3)';
            } else {
                statusDiv.style.background = 'rgba(59, 130, 246, 0.1)';
                statusDiv.style.color = '#93c5fd';
                statusDiv.style.border = '1px solid rgba(59, 130, 246, 0.3)';
            }
            
            statusDiv.textContent = message;
            
            setTimeout(() => {
                statusDiv.style.opacity = '0.8';
            }, 5000);
        }

        // 圖像上傳處理
        function handleUploadAreaClick(event) {
            const uploadContent = document.getElementById('uploadContent');
            const imagePreview = document.getElementById('imagePreview');
            
            if (uploadContent && uploadContent.style.display !== 'none') {
                // 如果點擊的不是按鈕，則觸發文件選擇
                if (!event.target.classList.contains('control-btn') && !event.target.closest('.control-btn')) {
                    document.getElementById('imageUpload').click();
                }
            } else if (imagePreview && imagePreview.style.display !== 'none') {
                // 如果已有圖像，點擊空白區域不做任何操作
                return;
            }
        }

        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (file && file.type.startsWith('image/')) {
                if (file.size > 10 * 1024 * 1024) {
                    showToast('圖像文件過大，請選擇小於 10MB 的圖像', 'error');
                    return;
                }
                
                processSelectedImage(file, '📁 圖像已選擇');
            }
        }

        function removeImage() {
            referenceImageFile = null;
            document.getElementById('uploadContent').style.display = 'block';
            document.getElementById('imagePreview').style.display = 'none';
            document.getElementById('imageUpload').value = '';
            document.getElementById('geminiResults').style.display = 'none';
            document.getElementById('pixarResults').style.display = 'none';
            geminiAnalysisData = null;
            showToast('🗑️ 已移除圖像');
        }

        function processSelectedImage(file, successMessage) {
            referenceImageFile = file;
            const reader = new FileReader();
            reader.onload = function(e) {
                const previewImg = document.getElementById('previewImg');
                const uploadContent = document.getElementById('uploadContent');
                const imagePreview = document.getElementById('imagePreview');
                
                previewImg.src = e.target.result;
                uploadContent.style.display = 'none';
                imagePreview.style.display = 'block';
                
                document.getElementById('geminiResults').style.display = 'none';
                document.getElementById('pixarResults').style.display = 'none';
                document.getElementById('pixarBtn').style.display = 'none';
                document.getElementById('applyBtn').style.display = 'none';
                
                showToast(`✅ ${successMessage}，點擊 "Gemini 解析" 開始 AI 識別`);
            };
            reader.readAsDataURL(file);
        }

        function handleImageDrop(event) {
            event.preventDefault();
            event.stopPropagation();
            
            const uploadArea = event.currentTarget;
            uploadArea.classList.remove('dragover');
            
            const files = event.dataTransfer.files;
            if (files.length > 0 && files[0].type.startsWith('image/')) {
                const fakeEvent = { target: { files: [files[0]] } };
                handleImageUpload(fakeEvent);
            }
        }

        function handleDragOver(event) {
            event.preventDefault();
            event.stopPropagation();
            event.currentTarget.classList.add('dragover');
        }

        function handleDragLeave(event) {
            event.preventDefault();
            event.stopPropagation();
            event.currentTarget.classList.remove('dragover');
        }

        // 文件轉 base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const base64 = reader.result.split(',')[1];
                    resolve(base64);
                };
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }

        // Google Gemini AI 分析
        async function analyzeWithGemini() {
            if (!referenceImageFile) {
                showToast('❌ 請先上傳圖像', 'error');
                return;
            }
            
            if (!userApiKey) {
                showToast('❌ 請先在設定中輸入 Gemini API Key', 'error');
                return;
            }
            
            const analyzeBtn = document.getElementById('analyzeBtn');
            const originalText = analyzeBtn.textContent;
            analyzeBtn.textContent = '🧠 分析中...';
            analyzeBtn.disabled = true;
            
            updateApiStatus('connecting', '🔄 Gemini AI 分析中...');
            
            try {
                const base64Image = await fileToBase64(referenceImageFile);
                
                const requestBody = {
                    contents: [{
                        parts: [
                            {
                                text: "請詳細分析這張圖像，包括：\n1. 主要物體和場景描述\n2. 色彩和光線特點\n3. 構圖和風格特色\n4. 情感氛圍\n5. 適合的藝術風格建議\n6. AI 繪圖的關鍵詞建議\n\n請用繁體中文回答，格式清晰易讀。"
                            },
                            {
                                inline_data: {
                                    mime_type: referenceImageFile.type,
                                    data: base64Image
                                }
                            }
                        ]
                    }],
                    generationConfig: {
                        temperature: 0.7,
                        topK: 40,
                        topP: 0.95,
                        maxOutputTokens: 2048,
                    }
                };
                
                const response = await fetch(getGeminiApiUrl(), {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody)
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(`API 請求失敗: ${response.status} - ${errorData.error?.message || '未知錯誤'}`);
                }
                
                const data = await response.json();
                
                if (!data.candidates || !data.candidates[0] || !data.candidates[0].content) {
                    throw new Error('API 返回格式異常');
                }
                
                const analysisText = data.candidates[0].content.parts[0].text;
                geminiAnalysisData = analysisText;
                
                displayGeminiResults(analysisText);
                
                document.getElementById('pixarBtn').style.display = 'inline-block';
                document.getElementById('applyBtn').style.display = 'inline-block';
                
                updateApiStatus('connected', '✅ AI 分析完成');
                showToast('🎯 Gemini AI 圖像分析完成！');
                
            } catch (error) {
                console.error('Gemini API 分析錯誤:', error);
                updateApiStatus('error', '❌ 分析失敗');
                showToast('❌ 分析失敗: ' + error.message, 'error');
                
            } finally {
                analyzeBtn.textContent = originalText;
                analyzeBtn.disabled = false;
            }
        }

        function displayGeminiResults(analysisText) {
            const resultsDiv = document.getElementById('geminiResults');
            const contentDiv = document.getElementById('geminiContent');
            
            const formattedText = analysisText
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\n\n/g, '</p><p>')
                .replace(/\n/g, '<br>')
                .replace(/^/, '<p>')
                .replace(/$/, '</p>');
            
            contentDiv.innerHTML = `
                <div class="result-item">
                    <div class="result-label">📋 Gemini AI 詳細分析</div>
                    <div class="result-content">${formattedText}</div>
                </div>
            `;
            
            resultsDiv.style.display = 'block';
        }

        // Pixar 風格故事生成
        async function generatePixarStory() {
            if (!referenceImageFile) {
                showToast('❌ 請先上傳圖像', 'error');
                return;
            }
            
            if (!userApiKey) {
                showToast('❌ 請先在設定中輸入 Gemini API Key', 'error');
                return;
            }
            
            const pixarBtn = document.getElementById('pixarBtn');
            const originalText = pixarBtn.textContent;
            pixarBtn.textContent = '🎬 創作中...';
            pixarBtn.disabled = true;
            
            try {
                const base64Image = await fileToBase64(referenceImageFile);
                
                const requestBody = {
                    contents: [{
                        parts: [
                            {
                                text: "請根據這張圖像創作一個 Pixar 風格的溫馨故事，包含以下元素：\n1. 一個有趣的主角\n2. 一個小小的冒險或挑戰\n3. 友情、成長或愛的主題\n4. 溫暖人心的結局\n\n故事長度約 200-300 字，用繁體中文撰寫，風格要像 Pixar 動畫一樣充滿溫暖與希望。"
                            },
                            {
                                inline_data: {
                                    mime_type: referenceImageFile.type,
                                    data: base64Image
                                }
                            }
                        ]
                    }],
                    generationConfig: {
                        temperature: 0.8,
                        topK: 40,
                        topP: 0.95,
                        maxOutputTokens: 1024,
                    }
                };
                
                const response = await fetch(getGeminiApiUrl(), {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody)
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(`API 請求失敗: ${response.status} - ${errorData.error?.message || '未知錯誤'}`);
                }
                
                const data = await response.json();
                
                if (!data.candidates || !data.candidates[0] || !data.candidates[0].content) {
                    throw new Error('API 返回格式異常');
                }
                
                const story = data.candidates[0].content.parts[0].text;
                
                displayPixarStory(story);
                showToast('🎬 Pixar 故事創作完成！');
                
            } catch (error) {
                console.error('Pixar 故事生成錯誤:', error);
                showToast('❌ 故事生成失敗: ' + error.message, 'error');
            } finally {
                pixarBtn.textContent = originalText;
                pixarBtn.disabled = false;
            }
        }

        function displayPixarStory(storyText) {
            const resultsDiv = document.getElementById('pixarResults');
            const contentDiv = document.getElementById('pixarContent');
            
            const formattedStory = storyText
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\n\n/g, '</p><p>')
                .replace(/\n/g, '<br>')
                .replace(/^/, '<p>')
                .replace(/$/, '</p>');
            
            contentDiv.innerHTML = `
                <div class="result-item">
                    <div class="result-label">📖 Pixar 風格故事</div>
                    <div class="result-content" style="font-family: Georgia, serif; line-height: 1.8;">
                        ${formattedStory}
                    </div>
                </div>
            `;
            
            resultsDiv.style.display = 'block';
        }

        // 應用分析結果到提示詞
        async function applyToPrompt() {
            if (!geminiAnalysisData) {
                showToast('❌ 請先進行 Gemini AI 解析', 'error');
                return;
            }
            
            const promptTextarea = document.getElementById('prompt');
            
            try {
                // 顯示處理中狀態
                const applyBtn = document.getElementById('applyBtn');
                const originalText = applyBtn.textContent;
                applyBtn.textContent = '🔄 轉換中...';
                applyBtn.disabled = true;
                
                // 如果有 API Key，使用 Gemini 進行翻譯
                if (userApiKey) {
                    try {
                        const translationPrompt = `請將以下中文圖像描述轉換為簡潔的英文關鍵詞，用於 AI 圖像生成。只輸出英文關鍵詞，用逗號分隔，不要包含任何說明文字或編號：

${geminiAnalysisData}

要求：
- 只保留視覺描述內容
- 轉換為英文關鍵詞
- 用逗號分隔
- 去除所有分析性語言
- 專注於實際的圖像元素`;

                        const requestBody = {
                            contents: [{
                                parts: [{
                                    text: translationPrompt
                                }]
                            }],
                            generationConfig: {
                                temperature: 0.3,
                                topK: 20,
                                topP: 0.8,
                                maxOutputTokens: 512,
                            }
                        };
                        
                        const response = await fetch(getGeminiApiUrl(), {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(requestBody)
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            if (data.candidates && data.candidates[0] && data.candidates[0].content) {
                                let aiTranslatedPrompt = data.candidates[0].content.parts[0].text
                                    .replace(/^[^a-zA-Z]*/, '') // 移除開頭的非英文字符
                                    .replace(/[^a-zA-Z0-9\s,.-]/g, '') // 只保留英文、數字、空格、逗號、句號、連字號
                                    .replace(/\s*,\s*/g, ', ') // 標準化逗號格式
                                    .replace(/\s+/g, ' ') // 移除多餘空格
                                    .trim();
                                
                                if (aiTranslatedPrompt && aiTranslatedPrompt.length > 10) {
                                    promptTextarea.value = aiTranslatedPrompt;
                                    showToast('✨ 已使用 Gemini AI 將分析結果轉換為英文提示詞');
                                    return;
                                }
                            }
                        }
                    } catch (error) {
                        console.warn('Gemini 翻譯失敗，使用本地轉換:', error);
                    }
                }
                
                // 如果 Gemini 翻譯失敗或沒有 API Key，使用本地轉換
                const localTranslatedPrompt = convertAnalysisToAIPrompt(geminiAnalysisData);
                promptTextarea.value = localTranslatedPrompt;
                
                showToast('✨ 已將分析結果轉換為英文提示詞');
                
            } catch (error) {
                console.error('轉換錯誤:', error);
                showToast('❌ 轉換失敗: ' + error.message, 'error');
            } finally {
                // 恢復按鈕狀態
                const applyBtn = document.getElementById('applyBtn');
                applyBtn.textContent = '✨ 應用到提示詞';
                applyBtn.disabled = false;
            }
        }

        function convertAnalysisToAIPrompt(analysisText) {
            // 只提取純粹的圖像描述內容，轉換為英文關鍵詞
            let prompt = analysisText
                // 移除所有 Gemini 的開場白、總結和說明文字
                .replace(/好的[，,]?以下是對圖像的詳細分析[：:\s]*/g, '')
                .replace(/好的[，,]?讓我來詳細分析這張圖像[：:\s]*/g, '')
                .replace(/讓我來分析一下這張圖像[：:\s]*/g, '')
                .replace(/根據圖像分析[：:\s]*/g, '')
                .replace(/總結來說[：:\s]*/g, '')
                .replace(/綜合以上分析[：:\s]*/g, '')
                .replace(/希望這個分析對您有幫助[：:\s]*/g, '')
                .replace(/以上就是我對這張圖像的詳細分析[：:\s]*/g, '')
                .replace(/好的[，,]?我來為您詳細分析這張圖像[：:\s]*/g, '')
                .replace(/這張圖像的分析如下[：:\s]*/g, '')
                .replace(/讓我詳細描述這張圖像[：:\s]*/g, '')
                .replace(/分析結果如下[：:\s]*/g, '')
                
                // 移除所有段落標題和說明性文字
                .replace(/\d+\.\s*主要物體和場景描述[：:\s]*/g, '')
                .replace(/\d+\.\s*色彩和光線特點[：:\s]*/g, '')
                .replace(/\d+\.\s*構圖和風格特色[：:\s]*/g, '')
                .replace(/\d+\.\s*情感氛圍[：:\s]*/g, '')
                .replace(/\d+\.\s*適合的藝術風格建議[：:\s]*/g, '')
                .replace(/\d+\.\s*AI\s*繪圖的關鍵詞建議[：:\s]*/g, '')
                .replace(/【.*?】/g, '')
                .replace(/\*\*(.*?)\*\*/g, '$1')
                .replace(/\d+\.\s*/g, '')
                
                // 移除說明性和建議性文字
                .replace(/請注意[：:\s]*/g, '')
                .replace(/建議[：:\s]*/g, '')
                .replace(/推薦[：:\s]*/g, '')
                .replace(/可以看到[：:\s]*/g, '')
                .replace(/我們可以觀察到[：:\s]*/g, '')
                .replace(/從圖像中可以看出[：:\s]*/g, '')
                .replace(/這張圖像展現了[：:\s]*/g, '')
                .replace(/整體而言[：:\s]*/g, '')
                .replace(/總的來說[：:\s]*/g, '')
                .replace(/適合用於[：:\s]*/g, '')
                .replace(/關鍵詞包括[：:\s]*/g, '')
                .replace(/在AI繪圖中[：:\s]*/g, '')
                
                // 將所有中文描述詞轉換為英文（只保留實際的視覺描述）
                .replace(/圖像中|畫面中|照片中/g, '')
                .replace(/顯示|展示|呈現/g, '')
                .replace(/一(?:個|隻|位|名|張|幅|件|朵|棵)?/g, '')
                
                // 人物和角色
                .replace(/(?:年輕|美麗|可愛|漂亮)?(?:女性|女子|女人|少女|女孩)/g, 'woman')
                .replace(/(?:年輕|帥氣|英俊)?(?:男性|男子|男人|少年|男孩)/g, 'man')
                .replace(/(?:小)?(?:嬰兒|寶寶|孩子|兒童)/g, 'child')
                .replace(/人物|人/g, 'person')
                
                // 動物
                .replace(/(?:可愛的|小|白色的|黑色的)?(?:貓咪|貓|小貓)/g, 'cat')
                .replace(/(?:可愛的|小|大型的)?(?:狗|小狗|狗狗|犬)/g, 'dog')
                .replace(/(?:小)?鳥(?:兒)?/g, 'bird')
                .replace(/馬(?:匹)?/g, 'horse')
                
                // 物品和場景
                .replace(/桌子|餐桌|書桌/g, 'table')
                .replace(/椅子|座椅/g, 'chair')
                .replace(/窗戶|窗子|窗台/g, 'window')
                .replace(/門|房門/g, 'door')
                .replace(/花(?:朵)?|鮮花/g, 'flower')
                .replace(/樹|大樹|樹木/g, 'tree')
                .replace(/房子|房屋|建築/g, 'building')
                .replace(/汽車|車子|車輛/g, 'car')
                
                // 顏色
                .replace(/紅色|紅/g, 'red')
                .replace(/藍色|藍/g, 'blue')
                .replace(/綠色|綠/g, 'green')
                .replace(/黃色|黃/g, 'yellow')
                .replace(/白色|白/g, 'white')
                .replace(/黑色|黑/g, 'black')
                .replace(/粉紅色|粉色|粉/g, 'pink')
                .replace(/紫色|紫/g, 'purple')
                
                // 質感和風格（只保留基本的）
                .replace(/(?:很|非常|十分)?(?:溫暖|溫馨)/g, 'warm')
                .replace(/(?:很|非常|十分)?(?:柔和|溫柔|輕柔)/g, 'soft')
                .replace(/(?:很|非常|十分)?(?:鮮豔|明亮|亮麗|燦爛)/g, 'bright')
                .replace(/(?:很|非常|十分)?(?:美麗|漂亮|美好)/g, 'beautiful')
                .replace(/(?:很|非常|十分)?(?:可愛|萌)/g, 'cute')
                .replace(/(?:很|非常|十分)?(?:優雅|典雅)/g, 'elegant')
                .replace(/(?:很|非常|十分)?(?:自然|天然)/g, 'natural')
                .replace(/(?:很|非常|十分)?(?:清晰|清楚)/g, 'sharp')
                
                // 動作
                .replace(/坐著|坐在|坐/g, 'sitting')
                .replace(/站著|站立|站/g, 'standing')
                .replace(/躺著|躺在|躺/g, 'lying')
                .replace(/奔跑|跑步|跑/g, 'running')
                .replace(/行走|走路|走/g, 'walking')
                .replace(/微笑|笑/g, 'smiling')
                .replace(/看著|注視|凝視/g, 'looking')
                .replace(/飛行|飛翔|飛/g, 'flying')
                
                // 位置詞
                .replace(/(?:在)?(?:室內|房間內|屋內)/g, 'indoor')
                .replace(/(?:在)?(?:室外|戶外|外面)/g, 'outdoor')
                .replace(/(?:在)?(?:公園|花園)(?:裡|中)?/g, 'garden')
                .replace(/(?:在)?(?:海邊|海灘)(?:上)?/g, 'beach')
                .replace(/(?:在)?(?:森林|樹林)(?:裡|中)?/g, 'forest')
                
                // 天氣和光線
                .replace(/(?:溫暖的|明亮的)?(?:陽光|日光|太陽)/g, 'sunlight')
                .replace(/自然光(?:線)?/g, 'natural light')
                .replace(/柔和的?光(?:線)?/g, 'soft light')
                .replace(/強烈的?光(?:線)?/g, 'bright light')
                
                // 移除描述性連接詞和修飾詞
                .replace(/(?:非常|很|十分|相當|比較|較為|特別|特殊|獨特)\s*/g, '')
                .replace(/(?:具有|擁有|帶有|呈現|顯現)\s*/g, '')
                .replace(/(?:看起來|似乎|好像|感覺)\s*/g, '')
                .replace(/(?:整體|全體|整個|完整)\s*/g, '')
                .replace(/(?:主要|重要|關鍵|核心)\s*/g, '')
                .replace(/(?:基本|簡單|複雜|豐富)\s*/g, '')
                
                // 清理標點符號
                .replace(/[，。！？；：、]/g, ' ')
                .replace(/\s+/g, ' ')
                .replace(/^\s+|\s+$/g, '')
                
                // 將句子片段轉換為關鍵詞格式
                .split(/\s+/)
                .filter(word => word.length > 0)
                .filter(word => !word.match(/^(的|了|在|和|與|或|及|等|也|還|就|都|會|能|可以|應該|可能)$/))
                .join(', ');
            
            // 如果處理後內容為空或太短，返回基本描述
            if (!prompt || prompt.length < 10) {
                return 'detailed artwork';
            }
            
            return prompt;
        }

        // 提示詞相關功能
        function generateRandomPrompt() {
            const subjects = ['可愛的貓咪', '夢幻的獨角獸', '勇敢的小龍', '神秘的森林精靈', '太空探險家'];
            const settings = ['在彩虹橋上', '在魔法城堡裡', '在星空下', '在花園中', '在雲朵上'];
            const styles = ['Pixar 動畫風格', '吉卜力工作室風格', '迪士尼風格', '夢幻風格', '可愛卡通風格'];
            const extras = ['3D 渲染', '高品質', '柔和光線', '溫暖色調', '細膩質感'];
            
            const randomSubject = subjects[Math.floor(Math.random() * subjects.length)];
            const randomSetting = settings[Math.floor(Math.random() * settings.length)];
            const randomStyle = styles[Math.floor(Math.random() * styles.length)];
            const randomExtra = extras[Math.floor(Math.random() * extras.length)];
            
            const randomPrompt = `${randomSubject}${randomSetting}，${randomStyle}，${randomExtra}`;
            
            document.getElementById('prompt').value = randomPrompt;
            showToast('🎲 已生成隨機靈感提示詞');
        }

        function clearPrompt() {
            document.getElementById('prompt').value = '';
            showToast('🗑️ 已清空提示詞');
        }

        function enhancePrompt() {
            const promptTextarea = document.getElementById('prompt');
            const currentPrompt = promptTextarea.value.trim();
            
            if (!currentPrompt) {
                showToast('❌ 請先輸入一些描述', 'error');
                return;
            }
            
            const enhancements = [
                'high quality',
                'detailed',
                'masterpiece',
                'professional lighting',
                'vibrant colors'
            ];
            
            const enhancedPrompt = currentPrompt + ', ' + enhancements.join(', ');
            promptTextarea.value = enhancedPrompt;
            
            showToast('✨ 已美化提示詞');
        }

        // 平台選擇處理
        document.addEventListener('DOMContentLoaded', function() {
            const platformOptions = document.querySelectorAll('.platform-option');
            
            platformOptions.forEach(option => {
                option.addEventListener('click', function() {
                    platformOptions.forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                    const radio = this.querySelector('input[type="radio"]');
                    if (radio) radio.checked = true;
                });
            });
        });

        // 圖像生成函數
        async function generateImage() {
            console.log('🚀 開始生成圖像...');
            
            const promptEl = document.getElementById('prompt');
            const platformEl = document.querySelector('input[name="platform"]:checked');
            
            if (!promptEl) {
                console.error('❌ 找不到 prompt 元素');
                showToast('❌ 頁面初始化錯誤：缺少提示詞輸入框', 'error');
                return;
            }
            
            if (!platformEl) {
                console.error('❌ 找不到選中的平台');
                showToast('❌ 請選擇一個 AI 生成平台', 'error');
                return;
            }
            
            const prompt = promptEl.value.trim();
            
            if (!prompt) {
                showToast('❌ 請輸入圖像描述', 'error');
                return;
            }
            
            const width = document.getElementById('width')?.value || '1024';
            const height = document.getElementById('height')?.value || '1024';
            const seed = document.getElementById('seed')?.value || '100';
            const style = document.getElementById('style')?.value || '';
            const batchCount = parseInt(document.getElementById('batchCount')?.value || '1');
            const negativePrompt = document.getElementById('negativePrompt')?.value?.trim() || '';
            const platform = platformEl.value;
            
            // 組合最終提示詞：原始提示詞 + 選擇的藝術風格
            let finalPrompt = prompt;
            if (style && style.trim() !== '') {
                finalPrompt = `${prompt}, ${style}`;
                console.log('✅ 已添加藝術風格:', style);
            }
            
            console.log('🎨 最終提示詞:', finalPrompt);
            
            let loadingEl = document.getElementById('loading');
            let generateBtn = document.getElementById('generateBtn');
            let errorEl = document.getElementById('error');
            let successEl = document.getElementById('success');
            let resultEl = document.getElementById('result');
            
            if (!resultEl) {
                resultEl = document.createElement('div');
                resultEl.id = 'result';
                resultEl.style.marginTop = '25px';
                document.querySelector('.center-panel').appendChild(resultEl);
            }
            
            if (loadingEl) loadingEl.style.display = 'block';
            if (generateBtn) generateBtn.disabled = true;
            if (errorEl) errorEl.style.display = 'none';
            if (successEl) successEl.style.display = 'none';
            if (resultEl) resultEl.innerHTML = '';
            
            try {
                const images = [];
                
                for (let i = 0; i < batchCount; i++) {
                    const currentSeed = parseInt(seed) + i;
                    let imageUrl;
                    
                    if (platform === 'pollinations') {
                        imageUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(finalPrompt)}?width=${width}&height=${height}&seed=${currentSeed}&nologo=true`;
                    } else if (platform === 'pollinations_enhanced') {
                        imageUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(finalPrompt)}?width=${width}&height=${height}&seed=${currentSeed}&enhance=true&nologo=true`;
                    } else if (platform === 'pollinations_sdxl') {
                        imageUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(finalPrompt)}?width=${width}&height=${height}&seed=${currentSeed}&model=flux&nologo=true`;
                    }
                    
                    if (negativePrompt) {
                        imageUrl += `&negative=${encodeURIComponent(negativePrompt)}`;
                    }
                    
                    console.log(`🔗 圖像 ${i + 1} URL:`, imageUrl);
                    
                    images.push({
                        url: imageUrl,
                        seed: currentSeed
                    });
                }
                
                displayGeneratedImages(images, finalPrompt);
                
                if (successEl) {
                    successEl.textContent = `✅ 成功生成 ${batchCount} 張圖像！${style ? ` (風格: ${style})` : ''}`;
                    successEl.style.display = 'block';
                }
                
                // 顯示所使用的完整提示詞
                showToast(`🎨 已使用提示詞生成圖像${style ? ' (含藝術風格)' : ''}`);
                
            } catch (error) {
                console.error('❌ 圖像生成錯誤:', error);
                if (errorEl) {
                    errorEl.textContent = `❌ 生成失敗: ${error.message}`;
                    errorEl.style.display = 'block';
                }
                showToast('❌ 生成失敗: ' + error.message, 'error');
            } finally {
                if (loadingEl) loadingEl.style.display = 'none';
                if (generateBtn) generateBtn.disabled = false;
            }
        }

        function displayGeneratedImages(images, prompt) {
            let resultDiv = document.getElementById('result');
            
            if (!resultDiv) {
                resultDiv = document.createElement('div');
                resultDiv.id = 'result';
                resultDiv.style.marginTop = '25px';
                document.querySelector('.center-panel').appendChild(resultDiv);
            }
            
            try {
                let html = `
                    <div class="panel-section">
                        <h3 style="color: #60a5fa; margin-bottom: 25px;">🎨 生成結果 (${images.length} 張)</h3>
                        <div class="image-results">
                `;
                
                images.forEach((image, index) => {
                    const escapedUrl = escapeHtml(image.url);
                    const escapedPrompt = escapeHtml(prompt);
                    
                    html += `
                        <div class="image-result-item">
                            <h4 style="margin-bottom: 18px; color: #cbd5e1; font-size: 0.95rem;">圖像 ${index + 1} (種子: ${image.seed})</h4>
                            <img src="${escapedUrl}" 
                                 class="preview-image" 
                                 alt="生成的圖像 ${index + 1}"
                                 onclick="openImageInNewTab('${escapedUrl}')"
                                 onerror="handleImageError(this)">
                            <div style="display: flex; gap: 8px; justify-content: center; flex-wrap: wrap; margin-top: 15px;">
                                <button class="download-btn" onclick="downloadImage('${escapedUrl}', 'generated_image_${index + 1}_seed_${image.seed}.png')">
                                    📥 下載
                                </button>
                                <button class="download-btn" onclick="copyImageUrl('${escapedUrl}')">
                                    📋 複製
                                </button>
                                <button class="download-btn" onclick="addToHistory('${escapedUrl}', '${escapedPrompt}', ${image.seed})">
                                    💾 保存
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div></div>';
                
                resultDiv.innerHTML = html;
                
                if (images.length > 0) {
                    setTimeout(() => {
                        addToHistory(images[0].url, prompt, images[0].seed);
                    }, 1000);
                }
                
            } catch (error) {
                console.error('❌ 設置圖像顯示內容時發生錯誤:', error);
                showToast('❌ 顯示圖像時發生錯誤: ' + error.message, 'error');
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function openImageInNewTab(imageUrl) {
            window.open(imageUrl, '_blank');
        }

        function handleImageError(img) {
            img.style.display = 'none';
            const container = img.closest('.image-result-item');
            const errorDiv = document.createElement('div');
            errorDiv.style.cssText = 'text-align: center; padding: 40px; color: #f87171; background: rgba(239, 68, 68, 0.1); border-radius: 15px; font-size: 0.95rem; border: 1px solid rgba(239, 68, 68, 0.3);';
            errorDiv.innerHTML = '<h4>❌ 圖像加載失敗</h4><p>請稍後重試或嘗試不同的設定</p>';
            container.insertBefore(errorDiv, img);
        }

        function downloadImage(imageUrl, filename) {
            const link = document.createElement('a');
            link.href = imageUrl;
            link.download = filename;
            link.target = '_blank';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showToast('📥 開始下載圖像');
        }

        function copyImageUrl(imageUrl) {
            navigator.clipboard.writeText(imageUrl).then(() => {
                showToast('📋 圖像鏈接已複製到剪貼板');
            }).catch(() => {
                showToast('❌ 複製失敗', 'error');
            });
        }

        // 摺疊/展開功能
        function toggleSection(sectionName) {
            const content = document.getElementById(sectionName + 'Content');
            let toggleElement;
            
            if (sectionName === 'apiConfig') {
                toggleElement = document.getElementById('apiConfigToggle');
            } else if (sectionName === 'templates') {
                toggleElement = document.getElementById('templatesToggle');
            } else if (sectionName === 'negative') {
                toggleElement = document.getElementById('negativeToggle');
            } else if (sectionName === 'history') {
                toggleElement = document.getElementById('historyToggle');
            } else if (sectionName === 'guide') {
                toggleElement = document.getElementById('guideToggle');
            }
            
            if (!content) {
                console.warn(`找不到內容元素: ${sectionName}Content`);
                return;
            }
            
            if (content.classList.contains('collapsed')) {
                content.classList.remove('collapsed');
                if (toggleElement) toggleElement.textContent = '▼';
            } else {
                content.classList.add('collapsed');
                if (toggleElement) toggleElement.textContent = '▶';
            }
        }

        // 風格模板功能
        function applyTemplate(templateName) {
            const promptTextarea = document.getElementById('prompt');
            const templates = {
                '人物攝影': 'portrait photography, professional lighting, high quality, detailed face, sharp focus',
                '豎型構圖': 'vertical composition, tall aspect ratio, elegant pose, full body shot',
                '街拍風格': 'street photography style, urban background, candid shot, natural lighting',
                '光芒背景': 'radiant background, glowing light, ethereal atmosphere, dreamy lighting',
                '半身不帶臉': 'half body shot, no face visible, artistic composition, mysterious mood',
                '古風意境': 'traditional Chinese style, ancient aesthetic, elegant costume, cultural atmosphere',
                '主力消費': 'commercial photography, product focus, clean background, professional quality',
                '復古概念': 'vintage style, retro aesthetic, classic mood, nostalgic atmosphere',
                '浪漫意境': 'romantic atmosphere, soft lighting, dreamy mood, emotional depth'
            };
            
            const templatePrompt = templates[templateName] || templateName;
            const currentPrompt = promptTextarea.value.trim();
            
            if (currentPrompt) {
                promptTextarea.value = `${currentPrompt}, ${templatePrompt}`;
            } else {
                promptTextarea.value = templatePrompt;
            }
            
            showToast(`✨ 已應用 "${templateName}" 風格模板`);
        }

        // 負面提示詞功能
        function applyCommonNegatives() {
            const negativeTextarea = document.getElementById('negativePrompt');
            const commonNegatives = 'blurry, low quality, distorted, ugly, deformed, extra fingers, bad anatomy, watermark, signature, text';
            negativeTextarea.value = commonNegatives;
            showToast('📝 已套用常用排除項目');
        }

        function enhanceNegatives() {
            const negativeTextarea = document.getElementById('negativePrompt');
            const currentNegatives = negativeTextarea.value.trim();
            const enhancements = 'worst quality, low resolution, jpeg artifacts, cropped, duplicate, mutation';
            
            if (currentNegatives) {
                negativeTextarea.value = `${currentNegatives}, ${enhancements}`;
            } else {
                negativeTextarea.value = enhancements;
            }
            
            showToast('🔧 已完善負面提示詞');
        }

        function clearNegatives() {
            document.getElementById('negativePrompt').value = '';
            showToast('🗑️ 已清空負面提示詞');
        }

        // 快速設定功能
        function setDimensions(width, height) {
            document.getElementById('width').value = width;
            document.getElementById('height').value = height;
            showToast(`📐 已設定尺寸為 ${width}×${height}`);
        }

        function randomSeed() {
            const randomValue = Math.floor(Math.random() * 999999) + 1;
            document.getElementById('seed').value = randomValue;
            showToast(`🎲 已設定隨機種子值: ${randomValue}`);
        }

        function resetSettings() {
            document.getElementById('width').value = '1024';
            document.getElementById('height').value = '1024';
            document.getElementById('seed').value = '100';
            document.getElementById('style').value = '';
            document.getElementById('batchCount').value = '1';
            showToast('🔄 已重置所有設定');
        }

        // 歷史記錄功能
        function addToHistory(imageUrl, prompt, seed) {
            const historyItem = {
                id: Date.now(),
                imageUrl: imageUrl,
                prompt: prompt,
                seed: seed,
                timestamp: new Date().toLocaleString('zh-TW')
            };
            
            historyData.unshift(historyItem);
            
            if (historyData.length > 10) {
                historyData = historyData.slice(0, 10);
            }
            
            renderHistory();
            showToast('💾 已保存到歷史記錄');
        }

        function renderHistory() {
            const historyGrid = document.getElementById('historyGrid');
            
            if (historyData.length === 0) {
                historyGrid.innerHTML = `
                    <div style="text-align: center; color: #64748b; padding: 40px;">
                        🎨 您的創作歷史將在這裡顯示<br>
                        <small>開始生成圖像後，最近作品會自動保存</small>
                    </div>
                `;
                return;
            }
            
            let html = '';
            historyData.forEach(item => {
                html += `
                    <div class="history-item">
                        <img src="${item.imageUrl}" 
                             class="history-image" 
                             alt="歷史圖像"
                             onclick="openImageInNewTab('${item.imageUrl}')"
                             onerror="this.style.display='none'">
                        <div class="history-info">
                            <div class="history-prompt">${item.prompt}</div>
                            <div class="history-date">${item.timestamp}</div>
                            <div class="history-date">種子: ${item.seed}</div>
                            <div class="history-actions">
                                <button class="history-btn" onclick="reusePrompt('${escapeHtml(item.prompt)}')">📝 重用</button>
                                <button class="history-btn" onclick="downloadImage('${item.imageUrl}', 'history_${item.id}.png')">📥 下載</button>
                                <button class="history-btn" onclick="removeFromHistory(${item.id})">🗑️ 刪除</button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            historyGrid.innerHTML = html;
        }

        function reusePrompt(prompt) {
            document.getElementById('prompt').value = prompt;
            showToast('📝 已重用歷史提示詞');
        }

        function removeFromHistory(id) {
            if (confirm('確定要刪除這個歷史記錄嗎？')) {
                historyData = historyData.filter(item => item.id !== id);
                renderHistory();
                showToast('🗑️ 已刪除歷史記錄');
            }
        }

        function clearHistory() {
            if (confirm('確定要清空所有歷史記錄嗎？')) {
                historyData = [];
                renderHistory();
                showToast('🗑️ 已清空所有歷史記錄');
            }
        }

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            updateApiStatus('connecting', '🔄 請設定 Gemini API Key');
            showToast('🚀 歡迎使用 ECF 深色版圖像解析與生成器！');
            
            document.getElementById('seed').value = Math.floor(Math.random() * 999999) + 1;
            
            renderHistory();
        });

    </script>
</body>
</html>